<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Site Survey Master | Jakub KURPANIK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn { @apply px-4 py-3 rounded-lg font-semibold shadow-sm transition-all active:scale-95; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-secondary { @apply bg-white text-slate-700 border border-slate-300; }
        .card { @apply bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4; }
        /* Smooth view transitions */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-20 max-w-2xl mx-auto">

    <header class="bg-white border-b sticky top-0 z-10 px-4 py-3 flex justify-between items-center shadow-sm">
        <div>
            <h1 class="font-bold text-slate-800 text-lg">Site Survey Master</h1>
            <p class="text-xs text-slate-500">Author: Jakub KURPANIK</p>
        </div>
        <button onclick="goBack()" id="backBtn" class="hidden text-sm text-blue-600 font-semibold">‚Üê Back</button>
    </header>

    <main class="p-4">
        <div id="view-projects" class="view-section active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Projects</h2>
                <button onclick="createNewProject()" class="btn btn-primary text-sm shadow-md">+ New Project</button>
            </div>
            <div id="projectsList" class="space-y-3">
                <p class="text-center text-slate-400 mt-8 text-sm">Loading database...</p>
            </div>
        </div>

        <div id="view-sections" class="view-section">
            <div class="mb-4">
                <h2 id="currentProjectTitle" class="text-xl font-bold text-slate-800">Project Name</h2>
                <p class="text-sm text-slate-500">Select or add a section/room</p>
            </div>
            <button onclick="createNewSection()" class="btn btn-primary w-full mb-6">+ Add Section (e.g., Kitchen)</button>
            <div id="sectionsList" class="space-y-3"></div>
            
            <hr class="my-6 border-slate-200">
            <button onclick="generatePDF()" class="btn btn-secondary w-full flex justify-center items-center gap-2">
                Generate PDF Report
            </button>
        </div>

        <div id="view-stages" class="view-section">
            <div class="mb-4">
                <h2 id="currentSectionTitle" class="text-xl font-bold text-slate-800">Section Name</h2>
                <p class="text-sm text-slate-500">Select progress stage</p>
            </div>
            <button onclick="createNewStage()" class="btn btn-primary w-full mb-6">+ Add Stage (e.g., First Fix)</button>
            <div id="stagesList" class="space-y-3"></div>
        </div>

        <div id="view-photos" class="view-section">
            <div class="mb-4">
                <h2 id="currentStageTitle" class="text-xl font-bold text-slate-800">Stage Name</h2>
                <p class="text-sm text-slate-500">Add photos and observations</p>
            </div>

            <div class="card bg-blue-50 border-blue-100">
                <label class="block w-full cursor-pointer">
                    <div class="flex flex-col items-center justify-center pt-4 pb-4">
                        <span class="text-sm font-semibold text-blue-600">üì∏ Take Photos (Multiple)</span>
                    </div>
                    <input type="file" class="hidden" accept="image/*" multiple capture="environment" onchange="handlePhotoUpload(this)">
                </label>
            </div>

            <div id="photosList" class="space-y-4"></div>
        </div>
    </main>

    <script>
        // --- UTILS ---
        // New simpler ID generator that works on all browsers
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // --- DATABASE LAYER (IndexedDB) ---
        const DB_NAME = 'SiteSurveyDB_v2';
        const STORE_NAME = 'projects';
        let db = null;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    console.log("DB Loaded");
                    resolve(db);
                };
                request.onerror = (e) => {
                    alert("Database failed to load. Please refresh.");
                    reject(e);
                };
            });
        };

        const dbAction = (type, data = null, key = null) => {
            if (!db) {
                alert("Database not ready yet. Please refresh the page.");
                return Promise.reject("DB not ready");
            }
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                let req;
                if (type === 'getAll') req = store.getAll();
                if (type === 'put') req = store.put(data);
                if (type === 'get') req = store.get(key);
                if (type === 'delete') req = store.delete(key);
                
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };

        // --- APP STATE ---
        let state = {
            currentProject: null,
            currentSection: null,
            currentStage: null,
            projects: []
        };

        // --- NAVIGATION ---
        const views = ['view-projects', 'view-sections', 'view-stages', 'view-photos'];
        
        function navigateTo(viewId) {
            views.forEach(v => document.getElementById(v).classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            const backBtn = document.getElementById('backBtn');
            if (viewId === 'view-projects') {
                backBtn.classList.add('hidden');
                loadProjects();
            } else {
                backBtn.classList.remove('hidden');
            }
        }

        function goBack() {
            const active = views.find(v => document.getElementById(v).classList.contains('active'));
            if (active === 'view-sections') navigateTo('view-projects');
            if (active === 'view-stages') navigateTo('view-sections');
            if (active === 'view-photos') navigateTo('view-stages');
        }

        // --- INITIALIZATION ---
        // Initialize DB and then load projects
        initDB().then(() => {
            loadProjects();
        }).catch(err => {
            console.error(err);
            document.getElementById('projectsList').innerHTML = '<p class="text-red-500">Error loading database.</p>';
        });

        // --- PROJECT LOGIC ---
        async function loadProjects() {
            try {
                state.projects = await dbAction('getAll') || [];
                const container = document.getElementById('projectsList');
                container.innerHTML = state.projects.length ? '' : '<p class="text-center text-slate-400 mt-8">No projects yet. Click + New Project.</p>';
                
                state.projects.sort((a,b) => b.updatedAt - a.updatedAt).forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'card cursor-pointer hover:border-blue-400 flex justify-between items-center';
                    div.innerHTML = `<div><h3 class="font-bold text-lg">${p.name}</h3><p class="text-xs text-slate-500">${new Date(p.updatedAt).toLocaleDateString()}</p></div><span class="text-slate-300">‚ûú</span>`;
                    div.onclick = () => openProject(p.id);
                    container.appendChild(div);
                });
            } catch (e) {
                console.error("Load error:", e);
            }
        }

        async function createNewProject() {
            if (!db) { alert("Please wait for database to load..."); return; }
            const name = prompt("Enter Project Name:");
            if (!name) return;
            
            const newProject = { 
                id: generateId(), 
                name, 
                createdAt: Date.now(), 
                updatedAt: Date.now(),
                sections: [] 
            };
            
            await dbAction('put', newProject);
            loadProjects();
        }

        function openProject(id) {
            state.currentProject = state.projects.find(p => p.id === id);
            document.getElementById('currentProjectTitle').innerText = state.currentProject.name;
