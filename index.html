<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Site Survey Master | Jakub KURPANIK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn { @apply px-4 py-3 rounded-lg font-semibold shadow-sm transition-all active:scale-95; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-secondary { @apply bg-white text-slate-700 border border-slate-300; }
        .card { @apply bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .loading { pointer-events: none; opacity: 0.6; }
    </style>
</head>
<body class="pb-20 max-w-2xl mx-auto">

    <header class="bg-white border-b sticky top-0 z-10 px-4 py-3 flex justify-between items-center shadow-sm">
        <div>
            <h1 class="font-bold text-slate-800 text-lg">Site Survey Master</h1>
            <p class="text-xs text-slate-500">Author: Jakub KURPANIK</p>
        </div>
        <button onclick="goBack()" id="backBtn" class="hidden text-sm text-blue-600 font-semibold">‚Üê Back</button>
    </header>

    <main class="p-4">
        <div id="view-projects" class="view-section active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Projects</h2>
                <button onclick="createNewProject()" class="btn btn-primary text-sm shadow-md">+ New Project</button>
            </div>
            <div id="projectsList" class="space-y-3">
                <p class="text-center text-slate-400 mt-8 text-sm">Loading database...</p>
            </div>
        </div>

        <div id="view-sections" class="view-section">
            <div class="mb-4">
                <h2 id="currentProjectTitle" class="text-xl font-bold text-slate-800">Project Name</h2>
                <p class="text-sm text-slate-500">Select or add a section/room</p>
            </div>
            <button onclick="createNewSection()" class="btn btn-primary w-full mb-6">+ Add Section (e.g., Kitchen)</button>
            <div id="sectionsList" class="space-y-3"></div>
            
            <hr class="my-6 border-slate-200">
            <button onclick="generatePDF()" class="btn btn-secondary w-full flex justify-center items-center gap-2">
                üìÑ Generate PDF Report
            </button>
        </div>

        <div id="view-stages" class="view-section">
            <div class="mb-4">
                <h2 id="currentSectionTitle" class="text-xl font-bold text-slate-800">Section Name</h2>
                <p class="text-sm text-slate-500">Select progress stage</p>
            </div>
            <button onclick="createNewStage()" class="btn btn-primary w-full mb-6">+ Add Stage (e.g., First Fix)</button>
            <div id="stagesList" class="space-y-3"></div>
        </div>

        <div id="view-photos" class="view-section">
            <div class="mb-4">
                <h2 id="currentStageTitle" class="text-xl font-bold text-slate-800">Stage Name</h2>
                <p class="text-sm text-slate-500">Add photos and observations</p>
            </div>

            <div class="card bg-blue-50 border-blue-100">
                <label class="block w-full cursor-pointer">
                    <div class="flex flex-col items-center justify-center pt-4 pb-4">
                        <span class="text-sm font-semibold text-blue-600">üì∏ Take Photos (Multiple)</span>
                        <span class="text-xs text-blue-400 mt-1">Photos will be compressed automatically</span>
                    </div>
                    <input type="file" class="hidden" id="photoInput" accept="image/*" multiple capture="environment" onchange="handlePhotoUpload(this)">
                </label>
            </div>

            <div id="photosList" class="space-y-4"></div>
        </div>
    </main>

    <script>
        // --- UTILS ---
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Image compression utility
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            const compressedReader = new FileReader();
                            compressedReader.onload = () => resolve(compressedReader.result);
                            compressedReader.onerror = reject;
                            compressedReader.readAsDataURL(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- DATABASE LAYER (IndexedDB) ---
        const DB_NAME = 'SiteSurveyDB_v2';
        const STORE_NAME = 'projects';
        let db = null;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    console.log("DB Loaded");
                    resolve(db);
                };
                request.onerror = (e) => {
                    console.error("Database error:", e);
                    alert("Database failed to load. Please refresh.");
                    reject(e);
                };
            });
        };

        const dbAction = (type, data = null, key = null) => {
            if (!db) {
                console.error("Database not ready");
                return Promise.reject("DB not ready");
            }
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    let req;
                    if (type === 'getAll') req = store.getAll();
                    if (type === 'put') req = store.put(data);
                    if (type === 'get') req = store.get(key);
                    if (type === 'delete') req = store.delete(key);
                    
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => {
                        console.error("DB operation error:", req.error);
                        reject(req.error);
                    };
                } catch(e) {
                    console.error("Transaction error:", e);
                    reject(e);
                }
            });
        };

        // --- APP STATE ---
        let state = {
            currentProject: null,
            currentSection: null,
            currentStage: null,
            projects: []
        };

        // --- NAVIGATION ---
        const views = ['view-projects', 'view-sections', 'view-stages', 'view-photos'];
        
        function navigateTo(viewId) {
            views.forEach(v => document.getElementById(v).classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            const backBtn = document.getElementById('backBtn');
            if (viewId === 'view-projects') {
                backBtn.classList.add('hidden');
                loadProjects();
            } else {
                backBtn.classList.remove('hidden');
            }
        }

        function goBack() {
            const active = views.find(v => document.getElementById(v).classList.contains('active'));
            if (active === 'view-sections') navigateTo('view-projects');
            if (active === 'view-stages') navigateTo('view-sections');
            if (active === 'view-photos') navigateTo('view-stages');
        }

        // --- INITIALIZATION ---
        let dbReady = false;
        initDB().then(() => {
            dbReady = true;
            loadProjects();
        }).catch(err => {
            console.error("Init error:", err);
            document.getElementById('projectsList').innerHTML = '<p class="text-red-500 text-center mt-8">Error loading database. Please refresh.</p>';
        });

        // --- PROJECT LOGIC ---
        async function loadProjects() {
            try {
                state.projects = await dbAction('getAll') || [];
                const container = document.getElementById('projectsList');
                container.innerHTML = state.projects.length ? '' : '<p class="text-center text-slate-400 mt-8">No projects yet. Click + New Project.</p>';
                
                state.projects.sort((a,b) => b.updatedAt - a.updatedAt).forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'card cursor-pointer hover:border-blue-400 flex justify-between items-center';
                    div.innerHTML = `<div><h3 class="font-bold text-lg">${escapeHtml(p.name)}</h3><p class="text-xs text-slate-500">${new Date(p.updatedAt).toLocaleDateString()}</p></div><span class="text-slate-300">‚ûú</span>`;
                    div.onclick = () => openProject(p.id);
                    container.appendChild(div);
                });
            } catch (e) {
                console.error("Load error:", e);
                document.getElementById('projectsList').innerHTML = '<p class="text-red-500 text-center mt-8">Error loading projects.</p>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function createNewProject() {
            if (!dbReady || !db) { 
                alert("Please wait for database to load..."); 
                return; 
            }
            const name = prompt("Enter Project Name:");
            if (!name || !name.trim()) return;
            
            const newProject = { 
                id: generateId(), 
                name: name.trim(), 
                createdAt: Date.now(), 
                updatedAt: Date.now(),
                sections: [] 
            };
            
            try {
                await dbAction('put', newProject);
                await loadProjects();
            } catch(e) {
                console.error("Create project error:", e);
                alert("Error creating project. Please try again.");
            }
        }

        function openProject(id) {
            state.currentProject = state.projects.find(p => p.id === id);
            document.getElementById('currentProjectTitle').innerText = state.currentProject.name;
            renderSections();
            navigateTo('view-sections');
        }

        // --- SECTION LOGIC ---
        function renderSections() {
            const container = document.getElementById('sectionsList');
            container.innerHTML = state.currentProject.sections.length ? '' : '<p class="text-slate-400 text-sm italic">No sections added.</p>';
            
            state.currentProject.sections.forEach(sec => {
                const div = document.createElement('div');
                div.className = 'card p-3 cursor-pointer hover:bg-slate-50 flex justify-between';
                div.innerHTML = `<span class="font-medium">${escapeHtml(sec.name)}</span> <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">${sec.stages.length} Stages</span>`;
                div.onclick = () => openSection(sec.id);
                container.appendChild(div);
            });
        }

        async function createNewSection() {
            const name = prompt("Section Name (e.g., Room 101):");
            if (!name || !name.trim()) return;
            state.currentProject.sections.push({
                id: generateId(),
                name: name.trim(),
                stages: []
            });
            await saveCurrentProject();
            renderSections();
        }

        function openSection(id) {
            state.currentSection = state.currentProject.sections.find(s => s.id === id);
            document.getElementById('currentSectionTitle').innerText = state.currentSection.name;
            renderStages();
            navigateTo('view-stages');
        }

        // --- STAGE LOGIC ---
        function renderStages() {
            const container = document.getElementById('stagesList');
            container.innerHTML = state.currentSection.stages.length ? '' : '<p class="text-slate-400 text-sm italic">No stages added.</p>';
            
            state.currentSection.stages.forEach(stage => {
                const div = document.createElement('div');
                div.className = 'card p-3 cursor-pointer hover:bg-slate-50 flex justify-between';
                div.innerHTML = `<span class="font-medium">${escapeHtml(stage.name)}</span> <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${stage.photos.length} Photos</span>`;
                div.onclick = () => openStage(stage.id);
                container.appendChild(div);
            });
        }

        async function createNewStage() {
            const name = prompt("Stage Name (e.g., First Fix):");
            if (!name || !name.trim()) return;
            state.currentSection.stages.push({
                id: generateId(),
                name: name.trim(),
                photos: []
            });
            await saveCurrentProject();
            renderStages();
        }

        function openStage(id) {
            state.currentStage = state.currentSection.stages.find(s => s.id === id);
            document.getElementById('currentStageTitle').innerText = state.currentStage.name;
            renderPhotos();
            navigateTo('view-photos');
        }

        // --- PHOTO LOGIC ---
        function renderPhotos() {
            const container = document.getElementById('photosList');
            container.innerHTML = '';
            
            if (state.currentStage.photos.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm italic text-center mt-4">No photos added yet.</p>';
                return;
            }
            
            state.currentStage.photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'card p-0 overflow-hidden';
                div.innerHTML = `
                    <img src="${photo.data}" class="w-full h-48 object-cover bg-slate-200" alt="Survey photo" />
                    <div class="p-3">
                        <textarea onblur="updateComment(${index}, this.value)" class="w-full text-sm p-2 border rounded bg-slate-50" rows="2" placeholder="Add comment...">${escapeHtml(photo.comment || '')}</textarea>
                        <button onclick="deletePhoto(${index})" class="text-xs text-red-500 mt-2 font-medium hover:text-red-700">üóë Delete Photo</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function handlePhotoUpload(input) {
            if (input.files && input.files.length > 0) {
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'card bg-blue-50 text-blue-800 text-center py-4';
                loadingMsg.textContent = `Processing ${input.files.length} photo(s)...`;
                document.getElementById('photosList').prepend(loadingMsg);

                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    try {
                        const compressed = await compressImage(file);
                        state.currentStage.photos.push({
                            id: generateId(),
                            data: compressed,
                            comment: "",
                            timestamp: Date.now()
                        });
                    } catch(e) {
                        console.error("Photo compression error", e);
                        alert(`Error processing photo ${i + 1}. It may be too large.`);
                    }
                }
                
                await saveCurrentProject();
                renderPhotos();
                input.value = '';
            }
        }

        async function updateComment(index, text) {
            try {
                state.currentStage.photos[index].comment = text;
                await saveCurrentProject();
            } catch(e) {
                console.error("Comment update error:", e);
            }
        }

        async function deletePhoto(index) {
            if(confirm("Delete this photo?")) {
                state.currentStage.photos.splice(index, 1);
                await saveCurrentProject();
                renderPhotos();
            }
        }

        async function saveCurrentProject() {
            try {
                state.currentProject.updatedAt = Date.now();
                await dbAction('put', state.currentProject);
            } catch(e) {
                console.error("Save error:", e);
                alert("Error saving. Your changes may not be preserved.");
            }
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const p = state.currentProject;
                
                let y = 20;

                // Header
                doc.setFontSize(22);
                doc.text(p.name, 10, y);
                y += 10;
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleDateString()} | Author: Jakub KURPANIK`, 10, y);
                y += 15;

                // Content
                p.sections.forEach(sec => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    doc.setFillColor(240, 240, 240);
                    doc.rect(10, y-6, 190, 8, 'F');
                    doc.setFontSize(14);
                    doc.setTextColor(0);
                    doc.text(sec.name, 12, y);
                    y += 15;

                    sec.stages.forEach(stage => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        
                        doc.setFontSize(12);
                        doc.setTextColor(50);
                        doc.text(`Stage: ${stage.name}`, 15, y);
                        y += 10;

                        stage.photos.forEach(photo => {
                            if (y > 210) { doc.addPage(); y = 20; }

                            try {
                                // Detect image format from base64 string
                                const format = photo.data.includes('data:image/png') ? 'PNG' : 'JPEG';
                                doc.addImage(photo.data, format, 20, y, 70, 50);
                                
                                doc.setFontSize(10);
                                doc.setTextColor(0);
                                const commentText = photo.comment || 'No comment';
                                const lines = doc.splitTextToSize(`Note: ${commentText}`, 90);
                                doc.text(lines, 100, y + 10);
                                
                                y += 60;
                            } catch (e) { 
                                console.error("PDF Image Error", e);
                                doc.setFontSize(10);
                                doc.setTextColor(200, 0, 0);
                                doc.text("Error loading image", 20, y);
                                y += 10;
                            }
                        });
                    });
                    y += 5;
                });

                doc.save(`${p.name}_Report.pdf`);
            } catch(e) {
                console.error("PDF generation error:", e);
                alert("Error generating PDF. Please try again.");
            }
        }
    </script>
</body>
</html>
